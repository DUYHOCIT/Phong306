<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trình xem GLB - Đã sửa điều khiển</title>

    <style>
        body { margin: 0; overflow: hidden; }
        canvas { display: block; }
        #info {
            position: absolute;
            top: 10px;
            width: 100%;
            text-align: center;
            color: white;
            font-family: Arial, sans-serif;
            font-size: 16px;
            text-shadow: 2px 2px 4px #000000;
            z-index: 10;
        }
    </style>
</head>
<body>
    <div id="info">
        W/A/S/D: Di chuyển | Q: Xuống | E: Lên | Dí chuột PHẢI để quay
    </div>

    <canvas id="webgl-canvas"></canvas>

    <script type="importmap">
    {
        "imports": {
            "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
            "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
        }
    }
    </script>

    <script type="module">
        import * as THREE from 'three';
        import { FlyControls } from 'three/addons/controls/FlyControls.js'; // Vẫn dùng FlyControls
        import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';

        // 1. Cài đặt cơ bản (Như cũ)
        const canvas = document.getElementById('webgl-canvas');
        const infoElement = document.getElementById('info');
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x333333);
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        camera.position.set(0, 2, 5);
        const renderer = new THREE.WebGLRenderer({ canvas: canvas, antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(window.devicePixelRatio);
        renderer.outputColorSpace = THREE.SRGBColorSpace;

        // 2. Ánh sáng (Như cũ)
        const ambientLight = new THREE.AmbientLight(0xffffff, 0.5); 
        scene.add(ambientLight);
        const directionalLight = new THREE.DirectionalLight(0xffffff, 2.5); 
        directionalLight.position.set(3, 10, 5);
        scene.add(directionalLight);
        const gridHelper = new THREE.GridHelper(50, 50);
        scene.add(gridHelper);

        // 3. TÙY CHỈNH ĐIỀU KHIỂN (PHẦN QUAN TRỌNG)
        const controls = new FlyControls(camera, renderer.domElement);
        controls.movementSpeed = 3.0;
        
        // --- SỬA LỖI 1: Tắt "đổ cam" (Roll) ---
        controls.rollSpeed = 0; 
        // ----------------------------------------

        // --- SỬA LỖI 3: Đổi phím E/Q ---
        // Xóa phím R (lên) và F (xuống) mặc định
        delete controls.keys['KeyR'];
        delete controls.keys['KeyF'];
        // Thêm phím E (lên) và Q (xuống)
        controls.keys['KeyE'] = 2; // 2 = 'up'
        controls.keys['KeyQ'] = 3; // 3 = 'down'
        // ---------------------------------

        // --- SỬA LỖI 2: Chỉ dí chuột phải mới quay ---
        // Tắt tính năng 'dí chuột' mặc định (là chuột trái)
        controls.dragToLook = false; 

        // Ngăn menu chuột phải hiện lên khi nhấn
        renderer.domElement.addEventListener('contextmenu', (event) => {
            event.preventDefault();
        });

        // Khi nhấn chuột
        renderer.domElement.addEventListener('mousedown', (event) => {
            // Nếu là chuột phải (button == 2)
            if (event.button === 2) {
                // Bật tạm thời tính năng 'dí chuột'
                controls.dragToLook = true;
                // Cập nhật lại trạng thái (quan trọng)
                controls.mousedown(event);
            }
        });

        // Khi thả chuột
        renderer.domElement.addEventListener('mouseup', (event) => {
            // Nếu là chuột phải (button == 2)
            if (event.button === 2) {
                // Tắt lại tính năng 'dí chuột'
                controls.dragToLook = false;
                // Cập nhật lại trạng thái (quan trọng)
                controls.mouseup(event);
            }
        });
        // ----------------------------------------
        
        // 4. Tải mô hình (Dùng link jsDelivr cho ổn định)
        const loader = new GLTFLoader();
        const modelURL = "https://cdn.jsdelivr.net/gh/DUYHOCIT/Phong302@main/phong302.glb"; 

        loader.load(modelURL, (gltf) => {
            const object = gltf.scene;
            const box = new THREE.Box3().setFromObject(object);
            const center = box.getCenter(new THREE.Vector3());
            object.position.sub(center);
            scene.add(object);
            infoElement.innerText = "Tải thành công! W/A/S/D | Q/E | Dí chuột PHẢI";
        }, (xhr) => {
            const percent = (xhr.loaded / xhr.total * 100).toFixed(0);
            infoElement.innerText = `Đang tải mô hình... ${percent}%`;
        }, (error) => {
            console.error("LỖI KHI TẢI FILE GLB:", error);
            infoElement.innerText = "LỖI: Không thể tải mô hình. Kiểm tra Console (F12).";
        });

        // 5. Vòng lặp Animation
        const clock = new THREE.Clock();
        function animate() {
            requestAnimationFrame(animate);
            const delta = clock.getDelta();
            controls.update(delta); // Cập nhật điều khiển
            renderer.render(scene, camera);
        }

        // 6. Xử lý khi thay đổi kích thước cửa sổ
        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });

        // Bắt đầu!
        animate();
    </script>
</body>
</html>
